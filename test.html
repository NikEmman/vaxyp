<!DOCTYPE html>
<html>
  <head>
    <title>Convert Word to Base64</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: darkgray;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      button,
      input {
        margin: 10px 0;
        padding: 8px 12px;
      }
      #base64Output {
        max-height: 200px;
        overflow: auto;
        background-color: #f5f5f5;
        padding: 10px;
        border: 1px solid #ddd;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
      }
      .success {
        color: green;
        display: none;
        margin-left: 10px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h2>Word Document to Base64 Converter</h2>

      <div>
        <input type="file" id="wordFile" accept=".docx" />
        <button onclick="convertToBase64()">Convert to Base64</button>
      </div>

      <div>
        <h3>Base64 Output:</h3>
        <pre id="base64Output"></pre>
        <button id="copy-button">Αντιγραφή</button>
        <span id="copy-success" class="success">Copied!</span>
      </div>

      <div>
        <button onclick="generateWord()">Generate Word Document</button>
      </div>
    </div>

    <script>
      // Store the original file ArrayBuffer
      let originalFileArrayBuffer = null;

      function convertToBase64() {
        var fileInput = document.getElementById("wordFile");
        if (!fileInput.files.length) {
          alert("Please select a file first.");
          return;
        }

        var file = fileInput.files[0];
        var reader = new FileReader();

        // First, read as ArrayBuffer and store it
        reader.onload = function (e) {
          originalFileArrayBuffer = e.target.result;

          // Now convert to base64 for display
          var base64reader = new FileReader();
          base64reader.onloadend = function () {
            var base64String = base64reader.result.split(",")[1];
            document.getElementById("base64Output").textContent = base64String;
            console.log("Base64 Encoding Complete");
          };

          // Create a new blob from the ArrayBuffer
          var blob = new Blob([originalFileArrayBuffer], { type: file.type });
          base64reader.readAsDataURL(blob);
        };

        reader.readAsArrayBuffer(file);
      }

      async function generateWord() {
        const base64String =
          document.getElementById("base64Output").textContent;

        if (!base64String) {
          alert("Please convert a file to base64 first.");
          return;
        }

        if (!originalFileArrayBuffer) {
          alert("Please select and convert a file first.");
          return;
        }

        try {
          // Use the original file ArrayBuffer instead of converting back from base64
          const modifiedDocx = await processDocument(
            originalFileArrayBuffer,
            replacements
          );

          // Create a blob and download it
          const blob = new Blob([modifiedDocx], {
            type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          });

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "generated_document.docx";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log("Document generated successfully");
        } catch (error) {
          console.error("Error generating Word document:", error);
          alert("Error generating Word document: " + error.message);
        }
      }
      async function processDocument(arrayBuffer, replacements) {
        try {
          console.log("Processing document...");

          // Load the document using JSZip
          const zip = await JSZip.loadAsync(arrayBuffer);
          console.log("ZIP loaded successfully");

          // Debug: List all files in the zip
          Object.keys(zip.files).forEach((filename) => {
            console.log("File in ZIP:", filename);
          });

          // Find the main document content
          const documentXml = zip.file("word/document.xml");

          if (!documentXml) {
            throw new Error("Could not find document.xml in the Word file");
          }

          console.log("Found document.xml");

          // Get the content
          const content = await documentXml.async("string");
          console.log("Document content loaded");

          // Replace placeholders with values
          let modifiedContent = content;
          for (const [placeholder, value] of Object.entries(replacements)) {
            const regex = new RegExp(`\\{${placeholder}\\}`, "g");
            modifiedContent = modifiedContent.replace(regex, value);
            console.log(`Replaced {${placeholder}} with ${value}`);
          }

          // Update the document.xml file in the ZIP
          zip.file("word/document.xml", modifiedContent);
          console.log("Updated document.xml in ZIP");

          // Generate the modified ZIP file as ArrayBuffer
          const modifiedZip = await zip.generateAsync({ type: "arraybuffer" });
          console.log("Generated modified ZIP");

          return modifiedZip;
        } catch (error) {
          console.error("Error in processDocument:", error);
          throw error;
        }
      }

      function copyToClipboard(textToCopy) {
        if (navigator.clipboard) {
          navigator.clipboard
            .writeText(textToCopy)
            .then(() => {
              console.log("Text copied to clipboard successfully!");
            })
            .catch((err) => {
              console.error("Could not copy text to clipboard: ", err);
            });
        } else {
          // Fallback for older browsers
          const textArea = document.createElement("textarea");
          textArea.value = textToCopy;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            console.log("Text copied to clipboard using fallback method!");
          } catch (err) {
            console.error("Could not copy text using fallback method: ", err);
          }
          document.body.removeChild(textArea);
        }
      }
      // Copy button functionality
      const stringBase64 = document
        .getElementById("copy-button")
        .addEventListener("click", function () {
          const text = document.getElementById("base64Output").textContent;
          copyToClipboard(text);
        });

      // Example replacements
      const replacements = {
        initial: "Σημερα στην Ανατολη 12 του μηνα ενωπιων εμας ολων",
        name: "John Doe",
        // Add more placeholder replacements as needed
      };
    </script>
  </body>
</html>
